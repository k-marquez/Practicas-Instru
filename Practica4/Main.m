clc
clear all;
close all;
global E R1 Rf Rl L Ric Ril

E = 10/2;   % Voltaje entrada
Rf = 50;    % Resistencia interna fuente
R1 = 1500;  % Resistencia 1
Ric = 200;    % Resistencia para medición de la corriente
Ril = 721;  % Resistencia para medición de la corriente
Rl = 29;    % Resistencia interna del inductor
L = 225e-3; % Inductancia
C = [3.5e-7 1e-6 3e-6]; % Capacitancia: [Sub Crítico Sobre]
% 3.5e-7F -> (.3uF) + (.01uF + .04uF) ó (.1uF + .2uF) + (.02uF + .03uF)
% 1e-6F -> 1uF
% 3e-6F -> (1uF + 2uF) ó 3uF


% Salida solución explícita:
%   - Il: Corriente en el inductor
%   - Vc: Voltaje en el capacitor
%   - Vl: Voltaje en el inductor
%   - Ic: Corriente en el capacitor
%   - Tiempo de simulación
eeSub= [0 0 0 0 0];   % Solución explícita subamortiguada
eeCritico = [0 0 0 0 0];  % Solución explícita críticamente amortiguada
eeSobre= [0 0 0 0 0]; % Solución explícita sobreamortiguada

% Salida solución numérica:
%   - Il: Corriente en el inductor
%   - Vc: Voltaje en el capacitor
%   - Vl: Voltaje en el inductor
%   - Ic: Corriente en el capacitor
%   - Tiempo de simulación
xxSub= [0 0 0 0 0];   % Simulación subamortiguada
xxCritico = [0 0 0 0 0];  % Simulación críticamente amortiguada
xxSobre= [0 0 0 0 0]; % Simulación sobreamortiguada

% Condiciones iniciales simulación
%   [Il Vc Vl Ic]
h0 = [-E/(R1+Rf+Ril+Rl) -R1*E/(R1+Rf+Ril+Rl) 2*E 0];

tspan = [0, 0.02;0.02, 0.04];

for i=1:2
    %___________________________ Subamortiguado ___________________________
    % Solución numérica
    [t, x] = ode23(@(t,x) EDOs(t,x,C(1)), tspan(:,i)', h0); 
    xxSub = [xxSub; [x, t]];
    % Sumando resistencia interna del voltaje
    xxSub(:,3) = xxSub(:,3) + xxSub(:,1)*Rl;
    
    %Solución explícita
    ee = [...
            E*(-(1/1150)*cosh((2849.293821i)*(t-t(1))).*exp(-3010.270776*(t-t(1)))+1/2300-(0.2200988218e-2i)*sinh((2849.293821i)*(t-t(1))).*exp(-3010.270776*(t-t(1)))) ...
            (-(30/23)*cosh((2849.293821i)*(t-t(1))).*exp(-3010.270776*(t-t(1)))+15/23+(1.378039749i)*sinh((2849.293821i)*(t-t(1))).*exp(-3010.270776*(t-t(1))))*E ...
            2*E*exp(-3010.270776*(t-t(1))).*(cosh((2849.293821i)*(t-t(1)))+(.4666414169i)*sinh((2849.293821i)*(t-t(1)))) ...
            -(0.2752660044e-2i)*E*exp(-3010.270776*(t-t(1))).*sinh((2849.293821i)*(t-t(1)))...
            t
         ];

    eeSub = [eeSub; ee];
    eeSub(:,3) = eeSub(:,3) + eeSub(:,1)*Rl;
    %______________________________ Crítico _______________________________
    % Solución numérica
    [t, xx] = ode23(@(t,x) EDOs(t,x,C(2)), tspan(:,i)', h0);
    xxCritico = [xxCritico; [xx, t]];
    % Sumando resistencia interna del voltaje
    xxCritico(:,3) = xxCritico(:,3) + xxCritico(:,1)*Rl;
    
    %Solución explícita
    ee = [...
            E*(-(1/1150)*cosh(241.8300654*(t-t(1))).*exp(-2464.052288*(t-t(1)))+1/2300+0.2789659224e-1*sinh(241.8300654*(t-t(1))).*exp(-2464.052288*(t-t(1)))) ...
            (-(30/23)*cosh(241.8300654*(t-t(1))).*exp(-2464.052288*(t-t(1)))+15/23-13.29024677*sinh(241.8300654*(t-t(1))).*exp(-2464.052288*(t-t(1))))*E ...
            2*E*exp(-2464.052288*(t-t(1))).*(cosh(241.8300654*(t-t(1)))-7.756756756*sinh(241.8300654*(t-t(1)))) ...
            0.3243243243e-1*E*sinh(241.8300654*(t-t(1))).*exp(-2464.052288*(t-t(1)))...
            t
         ];
    eeCritico = [eeCritico; ee];
    eeCritico(:,3) = eeCritico(:,3) + eeCritico(:,1)*Rl;
    
    %__________________________ Sobremortiguado ___________________________
    % Solución numérica
    [t, xxx] = ode23(@(t,x) EDOs(t,x,C(3)), tspan(:,i)', h0);
    xxSobre = [xxSobre; [xxx, t]];
    % Sumando resistencia interna del voltaje
    xxSobre(:,3) = xxSobre(:,3) + xxSobre(:,1)*Rl;
    
    %Solución explícita
    ee = [...
            E*(-(1/1150)*cosh(1771.820564*(t-t(1))).*exp(-2267.973856*(t-t(1)))+1/2300+0.3903746152e-2*sinh(1771.820564*(t-t(1))).*exp(-2267.973856*(t-t(1)))) ...
            (-(30/23)*cosh(1771.820564*(t-t(1))).*exp(-2267.973856*(t-t(1)))+15/23-1.669597265*sinh(1771.820564*(t-t(1))).*exp(-2267.973856*(t-t(1))))*E ...
            2*E*exp(-2267.973856*(t-t(1))).*(cosh(1771.820564*(t-t(1)))-1.169359622*sinh(1771.820564*(t-t(1)))) ...
            0.4426597936e-2*E*sinh(1771.820564*(t-t(1))).*exp(-2267.973856*(t-t(1)))...
            t
         ];

    eeSobre = [eeSobre; ee];
    eeSobre(:,3) = eeSobre(:,3) + eeSobre(:,1)*Rl;
    
    %__________________________ Cambio de Ciclo ___________________________
    E = -E; % Invirtiendo la entrada
    % Recalculando condiciones inciales de la simulación
    h0 = [...
            xxSub(end,1)... % Il(t)
            xxSub(end,2)... % Vc(t)
            (-1+Ric/(R1+Ric))*xxSub(end,2)+(-Rf-Rl-Ril-Ric*R1/(R1+Ric))*xxSub(end,1)+E... % Vl(t)
            (xxSub(end,1)*R1-xxSub(end,2))/(R1+Ric)... %Ic(t)
         ];
end

xxSobre = xxSobre(2:end, :);
eeSobre = eeSobre(2:end, :);

xxSub = xxSub(2:end, :);
eeSub = eeSub(2:end, :);

xxCritico = xxCritico(2:end, :);
eeCritico = eeCritico(2:end, :);

plotter(...
        {...
            'Sistema de Segundo Orden - Subamortiguado',...
            'Sistema de Segundo Orden - Críticamente Amortiguado'...
            'Sistema de Segundo Orden - Sobre Amortiguado'...
        },...
        2,...
        2,...
        {...
            {xxSub(:,1) eeSub(:,1) eeSub(:,1)} {xxSub(:,2) eeSub(:,2) eeSub(:,2)} {xxSub(:,3) eeSub(:,3) eeSub(:,3)} {xxSub(:,4) eeSub(:,4) eeSub(:,4)};...
            {xxCritico(:,1) eeCritico(:,1) eeCritico(:,1)} {xxCritico(:,2) eeCritico(:,2) eeCritico(:,2)} {xxCritico(:,3) eeCritico(:,3) eeCritico(:,3)} {xxCritico(:,4) eeCritico(:,4) eeCritico(:,4)};...
            {xxSobre(:,1) eeSobre(:,1) eeSobre(:,1)} {xxSobre(:,2) eeSobre(:,2) eeSobre(:,2)} {xxSobre(:,3) eeSobre(:,3) eeSobre(:,3)} {xxSobre(:,4) eeSobre(:,4) eeSobre(:,4)};...
        },...
        {...
            {xxSub(:,5) eeSub(:,5) eeSub(:,5)};...
            {xxCritico(:,5) eeCritico(:,5) eeCritico(:,5)};...
            {xxSobre(:,5) eeSobre(:,5) eeSobre(:,5)}...
        },...
        {'Corriente en el Inductor','Voltaje en el Capacitor','Voltaje en el Inductor','Corriente en el Capcitor'},...
        {'Simulación', 'Explícita', 'Medición'},...
        {'$t$'},...
        {'$I_{l}(t)$', '$V_{c}(t)$', '$V_{l}(t)$', '$I_{c}(t)$'},...
        true...
)

%_________________________ Diagrama de Fase ______________________________
plotter(...
        {'Diagramas de Fases'},...
        2,...
        3,...
        {...
            {xxSub(:,2) eeSub(:,2)},...
            {xxCritico(:,2) eeCritico(:,2)},...
            {xxSobre(:,2) eeSobre(:,2)},...
            {xxSub(:,4) eeSub(:,4)},...
            {xxCritico(:,4) eeCritico(:,4)},...
            {xxSobre(:,4) eeSobre(:,4)}...
        },...
        {...
            {xxSub(:,1) eeSub(:,1)},...
            {xxCritico(:,1) eeCritico(:,1)},...
            {xxSobre(:,1) eeSobre(:,1)},...
            {xxSub(:,3) eeSub(:,3)},...
            {xxCritico(:,3) eeCritico(:,3)},...
            {xxSobre(:,3) eeSobre(:,3)}...
        },...
        {'Subamortiguado','Críticamente Amortiguado','Sobre Amortiguado'},...
        {'Simu', 'Expl'},...
        {'$V_{c}(t)$', '$I_{c}(t)$'},...
        {'$I_{l}(t)$', '$V_{l}(t)$'},...
        false...
)