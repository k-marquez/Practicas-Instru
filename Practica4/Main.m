clc
clear all;
close all;
global E Rf Rl L Ric Ril C R1 T

E = 10/2;   % Voltaje entrada
Rf = 50;    % Resistencia interna fuente
Ric = 10100;    % Resistencia para medición de la corriente
Ril = 10810;  % Resistencia para medición de la corriente
Rl = 295;    % Resistencia interna del inductor
L = 161e-3; % Inductancia
C = 1000e-12; % Capacitancia
R1 = [11100 1060 778];  % Resistencia 1: [Sub Crítico Sobre]
F = 2.43e3;
T = 1/F;  % Frecuencia


%Carga de datos
LoadDataSubIndVl;
LoadDataSubIndIl;
LoadDataSubCapVc;
LoadDataSubCapIc;

LoadDataCriIndVl;
LoadDataCriIndIl;
LoadDataCriCapVc;
LoadDataCriCapIc;

LoadDataSobIndVl;
LoadDataSobIndIl;
LoadDataSobCapVc;
LoadDataSobCapIc;

% Salida solución explícita:
%   - Il: Corriente en el inductor
%   - Vc: Voltaje en el capacitor
%   - Vl: Voltaje en el inductor
%   - Ic: Corriente en el capacitor
%   - Tiempo de simulación
eeSub= [0 0 0 0 0];   % Solución explícita subamortiguada
eeCritico = [0 0 0 0 0];  % Solución explícita críticamente amortiguada
eeSobre= [0 0 0 0 0]; % Solución explícita sobreamortiguada

% Salida solución numérica:
%   - Il: Corriente en el inductor
%   - Vc: Voltaje en el capacitor
%   - Vl: Voltaje en el inductor
%   - Ic: Corriente en el capacitor
%   - Tiempo de simulación
xxSub= [0 0 0 0 0];   % Simulación subamortiguada
xxCritico = [0 0 0 0 0];  % Simulación críticamente amortiguada
xxSobre= [0 0 0 0 0]; % Simulación sobreamortiguada

% Condiciones iniciales simulación
%   [Il Vc Vl Ic]
h01 = [-E/(R1(1)+Rf+Ril+Rl) -R1(1)*E/(R1(1)+Rf+Ril+Rl) 2*E 0];
h02 = [-E/(R1(2)+Rf+Ril+Rl) -R1(2)*E/(R1(2)+Rf+Ril+Rl) 2*E 0];
h03 = [-E/(R1(3)+Rf+Ril+Rl) -R1(3)*E/(R1(3)+Rf+Ril+Rl) 2*E 0];
e01 = [-E/(R1(1)+Rf+Ril+Rl) -R1(1)*E/(R1(1)+Rf+Ril+Rl) 2*E 0];
e02 = [-E/(R1(2)+Rf+Ril+Rl) -R1(2)*E/(R1(2)+Rf+Ril+Rl) 2*E 0];
e03 = [-E/(R1(3)+Rf+Ril+Rl) -R1(3)*E/(R1(3)+Rf+Ril+Rl) 2*E 0];
e11 = [2*E/L 0 (2*(-Rf-Rl-Ril-Ric*R1(1)/(R1(1)+Ric)))*E/L 2*E*R1(1)/(L*(R1(1)+Ric))];
e12 = [2*E/L 0 (2*(-Rf-Rl-Ril-Ric*R1(2)/(R1(2)+Ric)))*E/L 2*E*R1(2)/(L*(R1(2)+Ric))];
e13 = [2*E/L 0 (2*(-Rf-Rl-Ril-Ric*R1(3)/(R1(3)+Ric)))*E/L 2*E*R1(3)/(L*(R1(3)+Ric))];

tSub = [SubIl.t(1:end/2) SubIl.t(end/2+1:end)];
tCri = [CriIl.t(1:end/2) CriIl.t(end/2+1:end)];
tSob = [SobIl.t(1:end/2) SobIl.t(end/2+1:end)];

for i = 1:2
    %___________________________ Subamortiguado ___________________________
    % Solución numérica
    [t, x] = ode23(@(t,x) EDOs(t,x,R1(1)), tSub(:,i), h01); 
    % Sumando resistencia interna del voltaje
    x(:,3) = x(:,3) + x(:,1)*Rl;
    xxSub = [xxSub; [x, t]];
    
    %Solución explícita
    ee = [...
            e01(1)*cosh((30782.09098*j)*(tSub(:,i)-tSub(1,i))).*exp(-74650.76760*(tSub(:,i)-tSub(1,i)))+(1/22255*(-cosh((30782.09098*j)*(tSub(:,i)-tSub(1,i))).*exp(-74650.76760*(tSub(:,i)-tSub(1,i)))+1))*E-(0.2138368515e-3*j)*sinh((30782.09098*j)*(tSub(:,i)-tSub(1,i))).*exp(-74650.76760*(tSub(:,i)-tSub(1,i)))*(-.5095960000*E+.1519215320*e11(1)+11341.05898*e01(1))...
            e01(2)*cosh((30782.09098*j)*(tSub(:,i)-tSub(1,i))).*exp(-74650.76760*(tSub(:,i)-tSub(1,i)))+(2220/4451*(-cosh((30782.09098*j)*(tSub(:,i)-tSub(1,i))).*exp(-74650.76760*(tSub(:,i)-tSub(1,i)))+1))*E-(0.2138368515e-3*j)*sinh((30782.09098*j)*(tSub(:,i)-tSub(1,i))).*exp(-74650.76760*(tSub(:,i)-tSub(1,i)))*(-5656.515600*E+.1519215320*e11(2)+11341.05898*e01(2))...
            exp(-74650.76760*(tSub(:,i)-tSub(1,i))).*(e01(3)*cosh((30782.09098*j)*(tSub(:,i)-tSub(1,i)))-(4.758939129*j)*sinh((30782.09098*j)*(tSub(:,i)-tSub(1,i)))*(.5095960000*e01(3)+0.6826400000e-5*e11(3)))...
            exp(-74650.76760*(tSub(:,i)-tSub(1,i))).*(e01(4)*cosh((30782.09098*j)*(tSub(:,i)-tSub(1,i)))-(4.758939129*j)*sinh((30782.09098*j)*(tSub(:,i)-tSub(1,i)))*(.5095960000*e01(4)+0.6826400000e-5*e11(4)))...
         ];
     
    ee(:,3) = ee(:,3) + ee(:,1)*Rl;
    eeSub = [eeSub; [ee, t]];
%     ______________________________ Crítico _______________________________
    % Solución numérica
    [t, xx] = ode23(@(t,x) EDOs(t,x,R1(2)), tCri(:,i)', h02);
    % Sumando resistencia interna del voltaje
    xx(:,3) = xx(:,3) + xx(:,1)*Rl;
    xxCritico = [xxCritico; [xx, t]];
    
    %Solución explícita
    ee = [...
            (1/12215)*E+(1/12215)*cosh((2114.582172*j)*(tCri(:,i)-tCri(1,i))).*exp(-82424.97610*(tCri(:,i)-tCri(1,i)))*(12215*e02(1)-E)-(0.1077362603e-1*j)*sinh((2114.582172*j)*(tCri(:,i)-tCri(1,i))).*exp(-82424.97610*(tCri(:,i)-tCri(1,i)))*(-.2961958000*E+0.4389484680e-1*e12(1)+3618.031696*e02(1))...
            e02(2)*cosh((2114.582172*j)*(tCri(:,i)-tCri(1,i))).*exp(-82424.97610*(tCri(:,i)-tCri(1,i)))+(212/2443*(-cosh((2114.582172*j)*(tCri(:,i)-tCri(1,i))).*exp(-82424.97610*(tCri(:,i)-tCri(1,i)))+1))*E-(0.1077362603e-1*j)*sinh((2114.582172*j)*(tCri(:,i)-tCri(1,i))).*exp(-82424.97610*(tCri(:,i)-tCri(1,i)))*(-313.9675480*E+0.4389484680e-1*e12(2)+3618.031696*e02(2))...
            exp(-82424.97610*(tCri(:,i)-tCri(1,i))).*(e02(3)*cosh((2114.582172*j)*(tCri(:,i)-tCri(1,i)))-(131.5998419*j)*sinh((2114.582172*j)*(tCri(:,i)-tCri(1,i)))*(.2961958000*e02(3)+0.3593520000e-5*e12(3)))...
            exp(-82424.97610*(tCri(:,i)-tCri(1,i))).*(e02(4)*cosh((2114.582172*j)*(tCri(:,i)-tCri(1,i)))-(131.5998419*j)*sinh((2114.582172*j)*(tCri(:,i)-tCri(1,i)))*(.2961958000*e02(4)+0.3593520000e-5*e12(4)))...
         ];
    
    ee(:,3) = ee(:,3) + ee(:,1)*Rl;
    eeCritico = [eeCritico; [ee, t]];
    
    %__________________________ Sobremortiguado ___________________________
    % Solución numérica
    [t, xxx] = ode23(@(t,x) EDOs(t,x,R1(3)), tSob(:,i)', h03);
    % Sumando resistencia interna del voltaje
    xxx(:,3) = xxx(:,3) + xxx(:,1)*Rl;
    xxSobre = [xxSobre; [xxx, t]];
    
    %Solución explícita
    ee = [...
            (1/11933)*E+(1/11933)*cosh(7116.257545*(tSob(:,i)-tSob(1,i))).*exp(-82850.53370*(tSob(:,i)-tSob(1,i)))*(11933*e03(1)-E)+0.3361969553e-2*sinh(7116.257545*(tSob(:,i)-tSob(1,i))).*exp(-82850.53370*(tSob(:,i)-tSob(1,i)))*(-.2902018900*E+0.4179791002e-1*e13(1)+3462.979153*e03(1)) ...
            e03(2)*cosh(7116.257545*(tSob(:,i)-tSob(1,i))).*exp(-82850.53370*(tSob(:,i)-tSob(1,i)))+(778/11933*(-cosh(7116.257545*(tSob(:,i)-tSob(1,i))).*exp(-82850.53370*(tSob(:,i)-tSob(1,i)))+1))*E+0.3361969553e-2*sinh(7116.257545*(tSob(:,i)-tSob(1,i))).*exp(-82850.53370*(tSob(:,i)-tSob(1,i)))*(-225.7770704*E+0.4179791003e-1*e13(2)+3462.979153*e03(2)) ...
            exp(-82850.53370*(tSob(:,i)-tSob(1,i))).*(e03(3)*cosh(7116.257545*(tSob(:,i)-tSob(1,i)))+40.11838267*sinh(7116.257545*(tSob(:,i)-tSob(1,i)))*(.2902018900*e03(3)+0.3502716000e-5*e13(3))) ...
            exp(-82850.53370*(tSob(:,i)-tSob(1,i))).*(e03(4)*cosh(7116.257545*(tSob(:,i)-tSob(1,i)))+40.11838267*sinh(7116.257545*(tSob(:,i)-tSob(1,i)))*(.2902018900*e03(4)+0.3502716000e-5*e13(4))) ...
         ];
    
    ee(:,3) = ee(:,3) + ee(:,1)*Rl;
    eeSobre = [eeSobre; [ee, t]];
    
    %__________________________ Cambio de Ciclo ___________________________
    E = -E; % Invirtiendo la entrada
    % Recalculando condiciones inciales de la simulación
    h01 = [...
            xxSub(end,1)... % Il(t)
            xxSub(end,2)... % Vc(t)
            (-1+Ric/(R1(1)+Ric))*xxSub(end,2)+(-Rf-Rl-Ril-Ric*R1(1)/(R1(1)+Ric))*xxSub(end,1)+E... % Vl(t)
            (xxSub(end,1)*R1(1)-xxSub(end,2))/(R1(1)+Ric)... %Ic(t)
         ];
     h02 = [...
            xxCritico(end,1)... % Il(t)
            xxCritico(end,2)... % Vc(t)
            (-1+Ric/(R1(2)+Ric))*xxCritico(end,2)+(-Rf-Rl-Ril-Ric*R1(2)/(R1(2)+Ric))*xxCritico(end,1)+E... % Vl(t)
            (xxCritico(end,1)*R1(2)-xxCritico(end,2))/(R1(2)+Ric)... %Ic(t)
         ];
     h03 = [...
            xxSobre(end,1)... % Il(t)
            xxSobre(end,2)... % Vc(t)
            (-1+Ric/(R1(3)+Ric))*xxSobre(end,2)+(-Rf-Rl-Ril-Ric*R1(3)/(R1(3)+Ric))*xxSobre(end,1)+E... % Vl(t)
            (xxSobre(end,1)*R1(3)-xxSobre(end,2))/(R1(3)+Ric)... %Ic(t)
         ];
     
    % Recalculando condiciones inciales de la simulación
    e01 = [
        eeSub(end,1)...
        eeSub(end,2)...
        (-1+Ric/(R1(1)+Ric))*eeSub(end,2)+(-Rf-Rl-Ril-Ric*R1(1)/(R1(1)+Ric))*eeSub(end,1)+E...
        (eeSub(end,1)*R1(1)-eeSub(end,2))/(R1(1)+Ric)...
    ];
    e02 = [
        eeCritico(end,1)...
        eeCritico(end,2)...
        (-1+Ric/(R1(2)+Ric))*eeCritico(end,2)+(-Rf-Rl-Ril-Ric*R1(2)/(R1(2)+Ric))*eeCritico(end,1)+E...
        (eeCritico(end,1)*R1(2)-eeCritico(end,2))/(R1(2)+Ric)...
    ];
    e03 = [
        eeSobre(end,1)...
        eeSobre(end,2)...
        (-1+Ric/(R1(3)+Ric))*eeSobre(end,2)+(-Rf-Rl-Ril-Ric*R1(3)/(R1(3)+Ric))*eeSobre(end,1)+E...
        (eeSobre(end,1)*R1(3)-eeSobre(end,2))/(R1(3)+Ric)...
    ];
    e11 = [
        ((-1+Ric/(R1(1)+Ric))*e01(2)+(-Rf-Rl-Ril-Ric*R1(1)/(R1(1)+Ric))*e01(1)+E)/L ...
        (e01(1)*R1(1)-e01(2))/((R1(1)+Ric)*C) ...
        (-1+Ric/(R1(1)+Ric))*e01(4)/C+(-Rf-Rl-Ril-Ric*R1(1)/(R1(1)+Ric))*e01(3)/L ...
        (e01(3)*R1(1)/L-e01(4)/C)/(R1(1)+Ric)...
    ];
    e12 = [
        ((-1+Ric/(R1(2)+Ric))*e02(2)+(-Rf-Rl-Ril-Ric*R1(2)/(R1(2)+Ric))*e02(1)+E)/L ...
        (e02(1)*R1(2)-e02(2))/((R1(2)+Ric)*C) ...
        (-1+Ric/(R1(2)+Ric))*e02(4)/C+(-Rf-Rl-Ril-Ric*R1(2)/(R1(2)+Ric))*e02(3)/L ...
        (e02(3)*R1(2)/L-e02(4)/C)/(R1(2)+Ric)...
    ];
    e13 = [
        ((-1+Ric/(R1(3)+Ric))*e03(2)+(-Rf-Rl-Ril-Ric*R1(3)/(R1(3)+Ric))*e03(1)+E)/L ...
        (e03(1)*R1(3)-e03(2))/((R1(3)+Ric)*C) ...
        (-1+Ric/(R1(3)+Ric))*e03(4)/C+(-Rf-Rl-Ril-Ric*R1(3)/(R1(3)+Ric))*e03(3)/L ...
        (e03(3)*R1(3)/L-e03(4)/C)/(R1(3)+Ric)...
    ];
end

xxSobre = xxSobre(2:end, :);
eeSobre = eeSobre(2:end, :);

xxSub = xxSub(2:end, :);
eeSub = eeSub(2:end, :);

xxCritico = xxCritico(2:end, :);
eeCritico = eeCritico(2:end, :);

plotter(...
        {...
            'Sistema de Segundo Orden - Subamortiguado',...
            'Sistema de Segundo Orden - Críticamente Amortiguado'...
            'Sistema de Segundo Orden - Sobre Amortiguado'...
        },...
        2,...
        2,...
        {...
            {xxSub(:,1) eeSub(:,1) SubIl.I} {xxSub(:,2) eeSub(:,2) SubVc.V} {xxSub(:,3) eeSub(:,3) SubVl.V} {xxSub(:,4) eeSub(:,4) SubIc.I};...
            {xxCritico(:,1) eeCritico(:,1) CriIl.I} {xxCritico(:,2) eeCritico(:,2) CriVc.V} {xxCritico(:,3) eeCritico(:,3) CriVl.V} {xxCritico(:,4) eeCritico(:,4) CriIc.I};...
            {xxSobre(:,1) eeSobre(:,1) SobIl.I} {xxSobre(:,2) eeSobre(:,2) SobVc.V} {xxSobre(:,3) eeSobre(:,3) SobVl.V} {xxSobre(:,4) eeSobre(:,4) SobIc.I};...
        },...
        {...
            {xxSub(:,5)} {xxSub(:,5)} {xxSub(:,5)} {xxSub(:,5)};...
            {xxCritico(:,5)} {xxCritico(:,5)} {xxCritico(:,5)} {xxCritico(:,5)};...
            {xxSobre(:,5)} {xxSobre(:,5)} {xxSobre(:,5)} {xxSobre(:,5)};...
        },...
        {'Corriente en el Inductor','Voltaje en el Capacitor','Voltaje en el Inductor','Corriente en el Capacitor'},...
        {'Simulación', 'Explícita','Medida'},...
        {'$t$'},...
        {'$I_{l}(t)$', '$V_{c}(t)$', '$V_{l}(t)$', '$I_{c}(t)$'},...
        true...
)

% %_________________________ Diagrama de Fase ______________________________
plotter(...
        {'Diagramas de Fases'},...
        2,...
        3,...
        {...
            {xxSub(:,2)},...
            {xxCritico(:,2)},...
            {xxSobre(:,2)},...
            {xxSub(:,4)},...
            {xxCritico(:,4)},...
            {xxSobre(:,4)}...
        },...
        {...
            {xxSub(:,1)},...
            {xxCritico(:,1)},...
            {xxSobre(:,1)},...
            {xxSub(:,3)},...
            {xxCritico(:,3)},...
            {xxSobre(:,3)}...
        },...
        {'Subamortiguado','Críticamente Amortiguado','Sobre Amortiguado'},...
        {'Simu'},...
        {'$V_{c}(t)$', '$I_{c}(t)$'},...
        {'$I_{l}(t)$', '$V_{l}(t)$'},...
        false...
)

errorsSub = Errors([SubIl.I SubVc.V SubVl.V SubIc.I], xxSub)
errorsCritico = Errors([CriIl.I CriVc.V CriVl.V CriIc.I], xxCritico)
errorsSobre = Errors([SobIl.I SobVc.V SobVl.V SobIc.I], xxSobre)
 
tiemposAsentamiento = TS([0.9244881460 996710825 1.003709316], [80748.21502 82452.09601 82544.35058])